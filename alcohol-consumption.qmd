---
title: "Student Alcohol Consumption"
title-block-banner: true
author: "Pascal Hasenkamp"
theme: minty
format: 
  html: 
    toc: true
    toc_float: true
    embed-resources: true
    code-fold: true
    code-summary: "Code anzeigen"
date: 2024-09-13
editor: 
  markdown: 
    wrap: sentence
---

```{r = packets, include=FALSE}
library(tidyverse)
library(tidymodels)
library(tidyverse) 
library(tidymodels)
library(explore) 
library(rpart.plot)
library(corrplot)
library(GGally)
library(tidyr)
library(dplyr)
library(ggplot2)
```

# Aufgabe und Daten verstehen

In dieser Arbeit sollen verschiedenste Zusammenhänge zwischen Lebensumständen bei Studenten zweier Kurse (Mathe, im Datensatz math und Portugiesisch, im Datensatz portuguese) einer "Secondary School", vergleichbar mit einer deutschen weiterführenden Schule, untersucht und beschrieben werden.

Hierzu stehen die Datensätze der Studenten bzw.
der Kurse bei Kaggle unter <https://www.kaggle.com/datasets/uciml/student-alcohol-consumption/data> zur Verfügung.

## Daten einlesen und zusammenführen

Als Start lesen wird beide Datensätze ein, aufgrund von Formatierungs und MergeProblemen wird noch das Encoding in "UTF-8" gesetzt.

```{r, message=FALSE}
d_mat <- read.csv("dataset/student-mat.csv", header = TRUE, fileEncoding = "UTF-8")
d_por <- read.csv("dataset/student-por.csv", header = TRUE, fileEncoding = "UTF-8")
```

Anschließend prüfen wir, dass alle gemeinsamen Spalten korrekt angegeben und in beiden Datensätzen vorhanden sind.
Die ausgewählten Spalten sind in der Datei "student-merge.R" des heruntergeladenen Archivs angegeben.

```{r, message=FALSE}
# Anzeigen der Spaltennamen in Datensatz Mathe
print(colnames(d_mat))
# Anzeigen der Spaltennamen in Datensatz Portugiesisch
print(colnames(d_por))

common_columns <- c("school", "sex", "age", "address", "famsize", "Pstatus", 
                    "Medu", "Fedu", "Mjob", "Fjob", "reason", "nursery", "internet")

# Vorhanden in beiden Datensätzen?
if (!all(common_columns %in% colnames(d_mat)) | !all(common_columns %in% colnames(d_por))) {
  stop("Nicht alle angegebenen Spalten sind in beiden Datensätzen vorhanden.")
}
```

Danach werden die beiden Datensätze in "untidy_student_data" zusammengeführt:

```{r, message=FALSE}
untidy_student_data <- merge(d_mat, d_por, by = common_columns)
```

## Aufbereitung und "tidy"

Der kombinierte Datensatz ist aktuell nicht als *tidy* zu betrachten.
Es wurde sich dafür entschieden einen kombinierten und aufgeräumten Datensatz zu erstellen, um beide Kurse gleichzeitig in der explorativen Datenanalyse zu betrachten und eine Einheitlichkeit bei der Datenstruktur zu behalten.
Die Übersichtlichkeit ist durch keine Dopplung einiger Attribute, wie es in einem Beispiel mit 2 Kursen und einem nicht gemergten Datensatz bzw.
einem Datensatz mit mehreren Kursen der Kursteilnehmer vorgelegen hätte, gegeben.

In dem Datensatz "untidy_student_data" wäre ein Datensatz mit 53 Spalten, hier haben die Studenten in den zusätzlichen Spalten, welche in 2 Kursen eingeschrieben sind.
Dieser Datensatz wird allerdings nicht weiterverwendet.

Das Kombinieren aus dem "untidy_student_data" Datensatz in einen "student_data" geschiet mit folgendem Code:

```{r, message=FALSE}
student_data <- untidy_student_data %>%
  pivot_longer(
    cols = ends_with(c(".x", ".y")), 
    names_to = c(".value", "course"),
    names_sep = "\\."
  ) %>%
  
  mutate(course = ifelse(course == "x", "Mathematik", "Portugiesisch"))
```

Die Daten sind nun in einem Datensatz, dem "student_data" zusammengefasst und haben die Spalte "course" erhalten.
Der Einfachheit halber werden die Datensätze ab jetzt als ein Datensatz behandelt.

Wir müssen uns nicht um das aufräumen von fehlenden Angaben kümmern, da es keine Beobachtungen mit fehlenden Einträgen gibt:

```{r, message=FALSE}
describe_tbl(student_data)
```

Zur Sicherung wird der kombinierte Datensatz noch als .csv exportiert:

```{r, message=FALSE}
write.csv(student_data, file = "dataset/student_data.csv", row.names = FALSE)
```

## Thesen aufstellen

Folgende Thesen sollen explorativ untersucht werden und kommen gegebenenfalls in der Modellfindung zum Einsatz.
Sollten Probleme mit Thesen auftreten oder sich neue Informationen aus diesen ergeben, wird dies in einem späteren Teil des Dokumentes behandelt.
Aufgrund des Datensatzes wurden 10 Thesen aufgestellt, im Vorhinein wurde sich mit der Dozentin auf die Aufstellung einer höheren Anzahl an Thesen geeinigt.

**These 1: Schüler, die in der Stadt leben, erzielen bessere Noten als Schüler auf dem Land.**

**These 2: Schüler, deren Eltern eine höhere Bildung haben, erzielen bessere Noten.**

**These 3: Schüler, die in einer intakten Familie leben, haben eine höhere durchschnittliche Abschlussnote.**

**These 4: Es gibt einen negativen Zusammenhang zwischen der Anzahl der vergangenen Fehler und der Abschlussnote.**

**These 5: Schüler, die regelmäßig Alkohol konsumieren, haben schlechtere Noten.**

**These 6: Das Geschlecht hat einen Einfluss auf die Schulleistung.**

**These 7: Schüler mit Zugang zum Internet zu Hause schneiden im Durchschnitt besser ab.**

**These 8: Schüler, mit einer höhere Abwesenheitsrate neigen dazu, schlechtere Noten zu haben.**

**These 9: Es gibt einen positiven Zusammenhang zwischen der Nutzung von Nachhilfe und den Abschlussnoten.**

**These 10: Schüler, die am Wochenende arbeiten, haben im Durchschnitt schlechtere Noten.**

Es wurden aufgrund des Umfanges der Analyse nicht alle Thesen mit Methoden der EDA untersucht.
Die Nummerierung wie sie hier zu finden ist, wird auch im Rest des Dokumentes für die Übersichtlichkeit verwendet.

## Überblick

Wir schauen uns die Daten zunächst einmal an:

```{r}
knitr::kable(head(student_data), caption = "Das Spaltenformat des eingelesenen Studentendatensatzes")
```

Der Datensatz hat **`r nrow(student_data)`** Zeilen und **`r ncol(student_data)`** Spalten.
Die Daten sind wie im vorherigen Teil der Dokumentation beschrieben *tidy*, das bedeutet:

1.  Jede Variable hat ihre eigene Spalte
2.  Jede Beobachtung hat ihre eigene Zeile
3.  Jeder Wert hat seine eigene Zelle

Die Variablen haben folgende Bedeutungen:

| Variable       | Typ  | Bedeutung                                                                                                            |
|:-------------------|:-------------------|:--------------------------------|
| **school**     | char | Schule des Schülers ('GP' - Gabriel Pereira oder 'MS' - Mousinho da Silveira)                                        |
| **sex**        | char | Geschlecht des Schülers ('F' - weiblich, 'M' - männlich)                                                             |
| **age**        | int  | Alter des Schülers (von 15 bis 22)                                                                                   |
| **address**    | char | Wohnort des Schülers ('U' - städtisch, 'R' - ländlich)                                                               |
| **famsize**    | char | Familiengröße ('LE3' - kleiner oder gleich 3, 'GT3' - größer als 3)                                                  |
| **Pstatus**    | char | Zusammenleben der Eltern ('T' - zusammen, 'A' - getrennt)                                                            |
| **Medu**       | int  | Bildungsniveau der Mutter (0 - keine, 1 - Grundschule, 2 - 5. bis 9. Klasse, 3 - Sekundarschule, 4 - höhere Bildung) |
| **Fedu**       | int  | Bildungsniveau des Vaters (0 - keine, 1 - Grundschule, 2 - 5. bis 9. Klasse, 3 - Sekundarschule, 4 - höhere Bildung) |
| **Mjob**       | char | Beruf der Mutter ('teacher', 'health', 'services', 'at_home', 'other')                                               |
| **Fjob**       | char | Beruf des Vaters ('teacher', 'health', 'services', 'at_home', 'other')                                               |
| **reason**     | char | Grund für die Wahl der Schule ('home', 'reputation', 'course', 'other')                                              |
| **guardian**   | char | Erziehungsberechtigter ('mother', 'father', 'other')                                                                 |
| **traveltime** | int  | Fahrzeit zur Schule (1 - \<15 Min., 2 - 15 bis 30 Min., 3 - 30 Min. bis 1 Std., 4 - \>1 Std.)                        |
| **studytime**  | int  | Wöchentliche Lernzeit (1 - \<2 Std., 2 - 2 bis 5 Std., 3 - 5 bis 10 Std., 4 - \>10 Std.)                             |
| **failures**   | int  | Anzahl der bisherigen Fehler (n, wenn 1 \<= n \< 3, sonst 4)                                                         |
| **schoolsup**  | char | Zusätzliche Bildungsunterstützung ('yes', 'no')                                                                      |
| **famsup**     | char | Familienunterstützung ('yes', 'no')                                                                                  |
| **paid**       | char | Zusätzliche bezahlte Klassen (Mathematik oder Portugiesisch) ('yes', 'no')                                           |
| **activities** | char | Teilnahme an außerschulischen Aktivitäten ('yes', 'no')                                                              |
| **nursery**    | char | Besuch des Kindergartens ('yes', 'no')                                                                               |
| **higher**     | char | Wunsch nach höherer Bildung ('yes', 'no')                                                                            |
| **internet**   | char | Internetzugang zu Hause ('yes', 'no')                                                                                |
| **romantic**   | char | In einer romantischen Beziehung ('yes', 'no')                                                                        |
| **famrel**     | int  | Qualität der familiären Beziehungen (1 - sehr schlecht bis 5 - exzellent)                                            |
| **freetime**   | int  | Freizeit nach der Schule (1 - sehr wenig bis 5 - sehr viel)                                                          |
| **goout**      | int  | Zeit mit Freunden verbringen (1 - sehr wenig bis 5 - sehr viel)                                                      |
| **Dalc**       | int  | Alkoholkonsum unter der Woche (1 - sehr wenig bis 5 - sehr viel)                                                     |
| **Walc**       | int  | Alkoholkonsum am Wochenende (1 - sehr wenig bis 5 - sehr viel)                                                       |
| **health**     | int  | Aktueller Gesundheitszustand (1 - sehr schlecht bis 5 - sehr gut)                                                    |
| **absences**   | int  | Anzahl der Abwesenheiten (0 bis 93)                                                                                  |
| **G1**         | int  | Note für die erste Periode (0 bis 20)                                                                                |
| **G2**         | int  | Note für die zweite Periode (0 bis 20)                                                                               |
| **G3**         | int  | Abschlussnote (0 bis 20, Zielvariable)                                                                               |

Zunächst verschaffen wir uns einen Überblick über die Daten.

```{r}
glimpse(student_data)
```

```{r}
summary(student_data)
```

## Ausreißerprüfung

Zuerst prüfen wir auf Ausreißer in den numerischen Variablen mit Hilfe von Boxplots

### Numerische Variablen identifizieren

```{r}
numeric_vars <- student_data %>% select(where(is.numeric))
```

### Boxplots für alle numerischen Variablen erstellen

```{r}
numeric_vars %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Wert") %>%
  ggplot(aes(x = Variable, y = Wert)) +
  geom_boxplot() +
  coord_flip() +  # bessere Lesbarkeit durch links/rechts Darstellung
  theme_minimal() +
  labs(title = "Boxplots zur Identifizierung von Ausreißern in numerischen Variablen")
```

Beschreibende Statistik für die numerischen Variablen, um einen Überblick zu bekommen

```{r}
summary(numeric_vars)
```

### Bereinigen der Ausreißer

Wir verwenden eine Funktion zur Erkennung und Entfernung von Ausreißern mit der IQR-Methode:

```{r}
remove_outliers <- function(data) {
  numeric_vars <- data %>% select(where(is.numeric))
  
  for (var in names(numeric_vars)) {
    Q1 <- quantile(numeric_vars[[var]], 0.25, na.rm = TRUE)
    Q3 <- quantile(numeric_vars[[var]], 0.75, na.rm = TRUE)
    IQR <- Q3 - Q1
    
    # Berechnung der oberen und unteren Grenzen für die Ausreißer
    lower_bound <- Q1 - 1.5 * IQR
    upper_bound <- Q3 + 1.5 * IQR
    
    # Filtern der Zeilen, die innerhalb der Grenzen liegen
    data <- data %>% filter((!!sym(var) >= lower_bound) & (!!sym(var) <= upper_bound))
  }
  
  return(data)
}
```

Entfernen der Ausreißer aus dem Datensatz bzw.
schreiben in einen neuen "student_data_cleaned" Datensatz:

```{r}
student_data_cleaned <- remove_outliers(student_data)
```

Und ein Überblick über den bereinigten Datensatz:

```{r}
summary(student_data_cleaned)
```

# Explorative Datenanalyse

Wir beginnen zuerst mit einem ersten Überblick über die Zusammenhänge und der Verteilung.
Hierfür schauen wir uns die Daten von These 1., These 2.
und These 7.
an.
Diese Thesen wurden aufgrund des möglichen Zusammenhanges mit der Abschlussnote ausgewählt, ohne direkt die negativen Aspekte des Alkoholkonsumes zu bewerten.

## Verteilung der Noten G1, G2 und G3

```{r}

ggplot(student_data_cleaned, aes(x = G1)) +
  geom_histogram(binwidth = 1, fill = "skyblue", color = "black") +
  labs(title = "Verteilung der Noten in der ersten Periode (G1)", x = "Note", y = "Häufigkeit")

ggplot(student_data_cleaned, aes(x = G2)) +
  geom_histogram(binwidth = 1, fill = "skyblue", color = "black") +
  labs(title = "Verteilung der Noten in der zweiten Periode (G2)", x = "Note", y = "Häufigkeit")

ggplot(student_data_cleaned, aes(x = G3)) +
  geom_histogram(binwidth = 1, fill = "skyblue", color = "black") +
  labs(title = "Verteilung der Abschlussnoten (G3)", x = "Note", y = "Häufigkeit")
```
Es ist erkennbar, dass die Notenverteilung über alle Perioden generell der Form der Standardabweichung ähnelt, die meisten Noten also im Mittelfeld angesiedelt sind.

## Einfluss der Thesen 1., 2. und 7. auf die Abschlussnote G3

### Wohnort x Abschlussnote

```{r}
ggplot(student_data_cleaned, aes(x = address, y = G3, fill = address)) +
  geom_boxplot() +
  labs(title = "Einfluss des Wohnorts auf die Abschlussnote", x = "Wohnort (U = städtisch, R = ländlich)", y = "Abschlussnote (G3)")
```

Im ersten Boxblot lässt sich die Verteilung so erkennen, dass Leute aus städtischen Gebieten eher eine bessere Note (=höhere Punktzahl) aufweisen, als Leute aus ländlichen Gebieten.

### Bildungsniveau Mutter x Abschlussnote

```{r}
ggplot(student_data_cleaned, aes(x = factor(Medu), y = G3, fill = factor(Medu))) +
  geom_boxplot() +
  labs(title = "Einfluss des Bildungsniveaus der Mutter auf die Abschlussnote", x = "Bildungsniveau der Mutter", y = "Abschlussnote (G3)")
```

In dieser Betrachtung ist erkennbar, dass der Trend in den Bildungskategorien 1-4 (Bildung ist vorhanden) zu einem steigenden Trend geht, je höher die Bildung der Mutter ist.
Lediglich bei keiner Bildung (=Bildungskategorie 0) reißt diese Verteilung aus und überzeugt mit einer hohen Punktzahl bei der Abschlussnote.

### Bildungsniveau Vater x Abschlussnote

```{r}
ggplot(student_data_cleaned, aes(x = factor(Fedu), y = G3, fill = factor(Fedu))) +
  geom_boxplot() +
  labs(title = "Einfluss des Bildungsniveaus des Vaters auf die Abschlussnote", x = "Bildungsniveau des Vaters", y = "Abschlussnote (G3)")
```

Die Verteilung lässt sich ähnlich Beschreiben wie bei "Bildungsniveau Mutter x Abschlussnote".
In Bildungskategorie 3 ist nur ein kleiner Abfall der Abschlussnote erkennbar.
Bei fehlender Bildung des Vaters gibt es weiterhin einer überdurchschnittlich hohe erreichte Punktzahl in der Abschlussnote.

### Internet Zuhause x Abschlussnote

```{r}
ggplot(student_data_cleaned, aes(x = internet, y = G3, fill = internet)) +
  geom_boxplot() +
  labs(title = "Einfluss von Internetzugang auf die Abschlussnote", x = "Internet zu Hause (Ja/Nein)", y = "Abschlussnote (G3)")
```

Kurz lässt sich hier erkennen, dass Leute mit Internet zu Hause durchschnittlich eine bessere Abschlussnote erreichen, als Leute ohne Internet zu Hause.

## Streudiagramm für These 8.

Durch den Bezug zur Abschlussnote G3 wird auch die Anzahl der Abwesenheiten betrachtet, diesmal in einem Streudiagramm:

```{r}

ggplot(student_data_cleaned, aes(x = absences, y = G3)) +
  geom_point(alpha = 0.6, color = "darkgrey", size = 2) +
  geom_smooth(formula = y ~ x,method = "lm", se = TRUE, color = "red", linetype = "dashed") + 
  labs(title = "Zusammenhang zwischen Abwesenheiten und Abschlussnote",
       x = "Anzahl der Abwesenheiten (absences)",
       y = "Abschlussnote (G3)") +
  theme_minimal()
```

Es lässt sich in der roten Regressionslinie (geom_smooth) ein Abwärtstrend erkennen, sprich, mit steigender Zahl der Abwesenheiten sinken die Leistungen und die Abschlussnoten werden schlechter.

## Korrelationsmatrix

Eine Variable in dem Datensatz hat eine Standardabweichung von 0:

```{r}
sd_check <- sapply(student_data_cleaned %>% select(where(is.numeric)), sd, na.rm = TRUE)
constant_vars <- names(sd_check[sd_check == 0])
print(constant_vars)
```

Es ist "failures", diese ist allerdings relevant, soll jedoch nicht mit in die Berechnung einbezogen werden, da sie konstant ist.

**Korrelationsmatrix der numerischen Variablen ohne 'failures'**

```{r}
student_data_cleaned_non_constant <- student_data_cleaned %>% select(-failures)
cor_matrix <- cor(student_data_cleaned_non_constant %>% select(where(is.numeric)), use = "complete.obs")
par(mar = c(1, 1, 4, 1))
corrplot(cor_matrix, method = "color", type = "upper", tl.cex = 0.7)
```
Diese Interpretationsmatrix hat die Variablen zueinander dargestellt, hierbei fällt folgendes auf:

### Positive Korrelation
Im Unteren Bereich ist zu erkennen, dass die Noten G1 und G2, sowie die Abschlussnote G3 eine starke positive Korrelation aufweisen. Eine konsistente Leistung in der Periode G1 und G2 spiegelt sich also in der Abschlussnote wieder.

Ebenfalls lässt sich zwischen der Bildung der Elternteile eine positive Korrelation feststellen. Eltern, bzw. Partner suchen sich oft gegenseitig mit ähnlichen Bildungsstufen aus.

Der Alkoholkonsum in der Woche (Dalc) sowie am Wochenende (Walc) korrelieren ebenfalls stark positiv miteinander, was darauf hinweist, dass Leute, die unter der Woche viel Alkohol trinken, dies auch am Wochenende tun. --> Hier kann direkt auf These 5 eingegangen werden, da keine klare Korrelation der Variablen Alkoholkonsum (Dalc/Walc) und der Abschlussnote (G3) erkennbar ist. Angenommen werden kann also, dass in dem Datensatz kein Starker Einfluss besteht oder andere Faktoren wichtiger für die Abschlussnote sind.

### Mittlere oder schwache Korrelation

Auch hier kann ein Fokus auf die Abschlussnote gelegt werden. Die Lernzeit (studytime) hat eine schwache positive Korrelation mit der Abschlussnote (G3), dies zeigt, dass eine höhere Lernzeit nur einen bedingten Einfluss auf eine bessere Abschlussnote hat. 

Die Abwesenheit (absence) hat eine leichte negative korrelation mit der Abschlussnote (G3), also ist eine häufige Abwesenheit mit schlechteren Noten verbunden, nur nicht mit einem starken Zusammenhang.

### Negative Korrelation

### Keine Korrelation

# Quellen

Zur Bearbeitung und Formatierung der Arbeit wurde das [offizielle Quarto-Wiki](https://quarto.org/docs/authoring/markdown-basics.html) genutzt, um Grafiken anschaulicher zu gestalten oder bestimmte Punkte besonders hervorzuheben.

Die Quelle der Daten ist wie in der Einleitung beschrieben ein bei [kaggle.com](https://www.kaggle.com/datasets/uciml/student-alcohol-consumption/data) zur Verfügung gestellter Datensatz bestehend aus 2 (bzw. 3) .csv Dateien.